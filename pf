from typing import Annotated

from common import htmx_utils
from database import get_session
from database.tasks import crud
from database.users import crud as users_crud
from fastapi import APIRouter, Body, Depends, HTTPException, Request
from fastapi.responses import HTMLResponse
from fastapi.templating import Jinja2Templates
from forms import tasks as tasks_forms
from services import tasks as tasks_service
from sqlmodel.ext.asyncio.session import AsyncSession

router = APIRouter()
templates = Jinja2Templates(directory="templates")


async def get_tasks_context(session: AsyncSession) -> dict:
    tasks = await crud.get_list(session)
    users = await users_crud.get_list(session)
    return {
        "tasks": tasks,
        "users": users,
        "all_completed": all(task.completed for task in tasks),
        "partially_completed": len([task for task in tasks if task.completed]),
    }


@router.get("/", response_class=HTMLResponse)
async def get_tasks(request: Request, session: AsyncSession = Depends(get_session)):
    context = await get_tasks_context(session)
    return htmx_utils.template_response(
        request=request,
        templates=templates,
        context=context,
        partial_template="tasks/_partials/index.html",
        full_template="tasks/index.html",
    )


@router.post("/tasks", response_class=HTMLResponse)
async def create_task(
    request: Request,
    form_data: Annotated[dict, Body()],
    session: AsyncSession = Depends(get_session),
):
    form = tasks_forms.TaskFormCreate(form_data)
    if not form.is_valid():
        context = await get_tasks_context(session)
        context["errors"] = form.form_errors()
        return htmx_utils.template_response(
            request=request,
            templates=templates,
            context=context,
            partial_template="tasks/_partials/tasks_list.html",
            full_template="tasks/index.html",
        )

    task = form.validated_model
    await tasks_service.create_task(session, task)
    context = await get_tasks_context(session)
    return htmx_utils.template_response(
        request=request,
        templates=templates,
        context=context,
        partial_template="tasks/_partials/tasks_list.html",
        full_template="tasks/index.html",
    )


@router.patch("/tasks/{task_id}", response_class=HTMLResponse)
async def complete_task(
    request: Request,
    task_id: int,
    form_data: Annotated[dict, Body()],
    session: AsyncSession = Depends(get_session),
):
    form = tasks_forms.TaskFormEdit(form_data)
    if not form.is_valid():
        context = await get_tasks_context(session)
        context["errors"] = form.form_errors()
        raise HTTPException(status_code=500, detail="unhandled")

    context = await get_tasks_context(session)
    return htmx_utils.template_response(
        request=request,
        templates=templates,
        context=context,
        partial_template="tasks/_partials/tasks_list.html",
        full_template="tasks/index.html",
    )


@router.patch("/tasks/{task_id}/assign/{user_id}", response_class=HTMLResponse)
async def assign_task(
    request: Request,
    task_id: int,
    user_id: int,
    session: AsyncSession = Depends(get_session),
):
    await tasks_service.assign_task(session, task_id, user_id)
    context = await get_tasks_context(session)
    return htmx_utils.template_response(
        request=request,
        templates=templates,
        context=context,
        partial_template="tasks/_partials/tasks_list.html",
        full_template="tasks/index.html",
    )
